# Story 2.1: Financial Health Scoring Engine

## Status

Draft

## Story

**As a** business owner with existing business data,  
**I want** my financial health calculated and scored from my current business information,  
**so that** I can understand my business's financial stability and performance immediately.

## Acceptance Criteria

1. [ ] Financial health scoring engine calculates scores from existing Business model data
2. [ ] Multi-dimensional health scores computed: Financial, Growth, Operational, Sale Readiness
3. [ ] Overall health score calculated as weighted average with confidence level
4. [ ] Health trajectory determined from available historical data patterns
5. [ ] Scoring handles missing or incomplete data gracefully with confidence adjustments
6. [ ] Health metrics populate existing HealthMetric database model from Story 1.1
7. [ ] Scoring triggered via existing `/api/health/calculate` endpoint from Story 1.2
8. [ ] Algorithm performance under 5 seconds for complete business analysis

## Tasks / Subtasks

- [ ] **Task 1: Financial Health Calculation Module** (AC: 1, 5, 8)
  - [ ] Create `src/lib/health-scoring/financial.ts` with financial health calculations
  - [ ] Implement profitability metrics (gross margin, net margin, EBITDA margin)
  - [ ] Calculate efficiency ratios (revenue per employee, asset utilization)
  - [ ] Assess liquidity indicators from cash flow and profit data
  - [ ] Handle missing financial data with partial scoring algorithms
  - [ ] Write comprehensive unit tests for all financial calculations

- [ ] **Task 2: Growth Health Calculation Module** (AC: 1, 4, 5)
  - [ ] Create `src/lib/health-scoring/growth.ts` for growth potential assessment
  - [ ] Calculate revenue growth trends from yearlyGrowth and revenue data
  - [ ] Assess market expansion potential from business category and description
  - [ ] Evaluate scalability factors from employee count and operational data
  - [ ] Determine growth trajectory classification (IMPROVING/STABLE/DECLINING/VOLATILE)
  - [ ] Test growth calculations with various business scenarios

- [ ] **Task 3: Operational & Sale Readiness Scoring** (AC: 1, 2, 5)
  - [ ] Create `src/lib/health-scoring/operational.ts` for operational efficiency
  - [ ] Build `src/lib/health-scoring/sale-readiness.ts` for market attractiveness
  - [ ] Assess operational health from business maturity, employees, customer base
  - [ ] Calculate sale readiness from asking price reasonableness, business attractiveness
  - [ ] Implement confidence scoring based on data completeness and quality
  - [ ] Create integration tests for all scoring dimensions

- [ ] **Task 4: Master Health Scoring Engine** (AC: 2, 3, 6, 7)
  - [ ] Create `src/lib/health-scoring/index.ts` as main scoring orchestrator
  - [ ] Implement weighted average calculation for overall health score
  - [ ] Integrate with existing HealthMetric model population
  - [ ] Connect to `/api/health/calculate` endpoint for business health generation
  - [ ] Add comprehensive error handling and logging
  - [ ] Write end-to-end tests for complete health scoring workflow

- [ ] **Task 5: Data Quality & Confidence Assessment** (AC: 3, 5)
  - [ ] Create `src/lib/health-scoring/confidence.ts` for data quality analysis
  - [ ] Implement data completeness scoring across all business fields
  - [ ] Calculate confidence adjustments based on missing critical data
  - [ ] Create data quality recommendations for users
  - [ ] Add validation for data consistency and reasonableness
  - [ ] Test confidence calculations with various data completeness scenarios

- [ ] **Task 6: Integration & Performance Optimization** (AC: 6, 7, 8)
  - [ ] Integrate health scoring with existing `/api/health/calculate` endpoint
  - [ ] Implement caching strategy for expensive calculations
  - [ ] Add performance monitoring and optimization for <5 second execution
  - [ ] Create comprehensive integration tests with actual business data
  - [ ] Add rate limiting integration testing
  - [ ] Verify HealthMetric model population and data persistence

## Dev Notes

### **Previous Story Insights**

[Source: docs/stories/1.1.database-schema-extensions.md#completion-notes-list & 1.2.core-api-endpoints.md#completion-notes-list]

**Story 1.1 Database Foundation:**

- HealthMetric model ready with fields: overallScore, growthScore, operationalScore, financialScore, saleReadinessScore, confidenceLevel, trajectory
- ForecastResult model available for future forecasting integration
- All models use `cuid()` primary keys with proper foreign key relationships
- Database migration scripts tested and working

**Story 1.2 API Infrastructure:**

- `/api/health/calculate` POST endpoint ready for health score generation
- `/api/health/[businessId]` GET endpoint ready for score retrieval
- Authentication, validation, and rate limiting already implemented
- TypeScript interfaces available in `src/types/health.ts`

### **Existing Business Data Structure**

[Source: src/app/api/businesses/route.ts analysis]

**Available Financial Data Fields:**

- Revenue metrics: `revenue`, `monthlyRevenue`, `yearlyGrowth`
- Profitability: `profit`, `ebitda`, `grossMargin`, `netMargin`
- Cash flow: `cashFlow`
- Assets: `inventory`, `equipment`, `realEstate`, `totalAssets`, `liabilities`
- Valuation: `askingPrice`

**Available Operational Data:**

- Business maturity: `established` (founding year)
- Scale: `employees`, `customerBase`
- Operations: `hoursOfOperation`, `daysOpen`, `seasonality`
- Market: `category`, `competition`, `description`

**Data Quality Considerations:**

- All financial fields are optional in current schema
- String-to-decimal conversion already implemented
- Data validation patterns established in existing business creation

### **Health Scoring Algorithm Design**

[Source: epic requirements and industry best practices]

**Financial Health Components (Weight: 40%):**

- Profitability Score (40%): Gross margin, net margin, EBITDA analysis
- Liquidity Score (30%): Cash flow adequacy, working capital assessment
- Efficiency Score (30%): Revenue per employee, asset turnover ratios

**Growth Health Components (Weight: 25%):**

- Revenue Growth (50%): YoY growth trends, growth sustainability
- Market Expansion (30%): Category potential, competitive positioning
- Scalability (20%): Operational capacity, employee growth patterns

**Operational Health Components (Weight: 20%):**

- Business Maturity (40%): Years in operation, operational stability
- Operational Efficiency (35%): Hours/days optimization, seasonal management
- Market Positioning (25%): Competition analysis, differentiation factors

**Sale Readiness Components (Weight: 15%):**

- Valuation Reasonableness (50%): Asking price vs calculated multiples
- Market Attractiveness (30%): Category demand, business presentation quality
- Documentation Quality (20%): Data completeness, transparency indicators

### **Architecture Integration**

[Source: docs/brownfield-architecture.md patterns]

**Service Layer Pattern:**

- Create modular scoring services in `src/lib/health-scoring/`
- Follow existing utility patterns from `src/lib/utils.ts`
- Use established error handling from `src/lib/openai.ts`
- Implement TypeScript interfaces for all calculation inputs/outputs

**API Integration:**

- Extend existing `/api/health/calculate` endpoint functionality
- Use established authentication and validation patterns
- Follow existing rate limiting and error response formats
- Integrate with current logging and monitoring systems

**Database Integration:**

- Use existing Prisma patterns for HealthMetric model population
- Follow established transaction handling for data consistency
- Use existing audit field patterns (createdAt, updatedAt, calculatedAt)
- Implement proper error handling for database operations

### **Performance & Scalability Considerations**

**Calculation Optimization:**

- Cache intermediate calculation results for complex algorithms
- Use efficient mathematical libraries for statistical calculations
- Implement lazy evaluation for optional score components
- Consider worker threads for CPU-intensive calculations if needed

**Data Handling:**

- Validate data types and ranges before calculation
- Handle null/undefined values gracefully in all algorithms
- Implement reasonable defaults for missing non-critical data
- Use existing decimal handling patterns from business creation

### **Testing Strategy**

[Source: existing patterns analysis]

**Unit Testing:**

- Test each scoring dimension independently with known data sets
- Verify edge cases: all data present, minimal data, invalid data
- Test confidence scoring accuracy across different completeness levels
- Validate mathematical correctness of weighted averaging

**Integration Testing:**

- Test complete health scoring workflow through API endpoints
- Verify HealthMetric model population and data persistence
- Test performance with realistic business data volumes
- Validate error handling and response formats

**Business Logic Validation:**

- Create test scenarios with actual business financial profiles
- Verify scoring makes intuitive business sense across industries
- Test confidence adjustments align with data quality assessment
- Validate trajectory classification logic with trend data

### **Error Handling & Edge Cases**

**Data Quality Issues:**

- Handle zero or negative revenue/profit scenarios appropriately
- Manage businesses with missing critical financial data
- Address inconsistent data (e.g., profit > revenue) with warnings
- Implement bounds checking for percentage-based metrics

**Business Scenarios:**

- New businesses (<1 year) with limited historical data
- Seasonal businesses with irregular revenue patterns
- Asset-heavy vs service businesses requiring different metrics
- Non-profit or special purpose entities requiring adapted scoring

**System Integration:**

- Handle database connection issues during score calculation
- Manage API timeout scenarios for complex calculations
- Implement graceful degradation when scoring components fail
- Ensure proper cleanup of partial calculations on errors

### **File Locations and Conventions**

[Source: src/ directory structure analysis]

**Core Health Scoring:**

- `src/lib/health-scoring/index.ts` - Main orchestration and overall scoring
- `src/lib/health-scoring/financial.ts` - Financial health calculations
- `src/lib/health-scoring/growth.ts` - Growth potential assessment
- `src/lib/health-scoring/operational.ts` - Operational efficiency scoring
- `src/lib/health-scoring/sale-readiness.ts` - Market attractiveness scoring
- `src/lib/health-scoring/confidence.ts` - Data quality and confidence assessment

**Supporting Utilities:**

- `src/lib/health-scoring/types.ts` - TypeScript interfaces for scoring
- `src/lib/health-scoring/constants.ts` - Scoring weights and thresholds
- `src/lib/health-scoring/utils.ts` - Common calculation utilities
- `src/types/health.ts` - Extended with new scoring interfaces

**API Integration:**

- Extend existing `src/app/api/health/calculate/route.ts`
- No new API endpoints needed - use existing infrastructure
- Follow established authentication and validation patterns

### **Business Logic Constants**

**Industry Benchmarks:**

- Gross margin thresholds by business category
- Revenue growth expectations by business maturity
- Employee efficiency ratios by industry type
- Asset turnover benchmarks by business model

**Scoring Thresholds:**

- Score ranges: 0-30 (Poor), 31-50 (Below Average), 51-70 (Average), 71-85 (Good), 86-100 (Excellent)
- Confidence levels: <50% (Low), 50-75% (Medium), 76-90% (High), >90% (Very High)
- Data completeness requirements for reliable scoring
- Minimum data thresholds for each scoring dimension

### **Future Integration Points**

**Extensibility Considerations:**

- Design scoring engine to accept additional data sources (QuickBooks, bank data, etc.)
- Create plugin architecture for new scoring dimensions
- Plan for industry-specific scoring adjustments
- Consider machine learning model integration for improved accuracy

**User Experience Integration:**

- Prepare score explanations for dashboard display
- Create actionable improvement recommendations
- Design confidence level presentation to users
- Plan for score change notifications and trending

## Change Log

| Date       | Version | Description                                       | Author      |
| ---------- | ------- | ------------------------------------------------- | ----------- |
| 2025-09-03 | 1.0     | Initial story creation with manual-first approach | BMad Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be added here after implementation_
