# Story 1.2: Core API Endpoints

## Status

Draft

## Story

**As a** frontend developer,  
**I want** RESTful API endpoints for health metrics and forecasting,  
**so that** I can build interactive dashboard components.

## Acceptance Criteria

1. [ ] `/api/health/[businessId]` endpoint returns current health scores with proper error handling
2. [ ] `/api/forecasts/[businessId]` endpoint provides forecasting data with confidence intervals
3. [ ] `/api/health/calculate` endpoint triggers health score recalculation
4. [ ] All endpoints follow existing API patterns (`src/app/api/` structure)
5. [ ] Proper TypeScript interfaces defined in `src/types/`
6. [ ] Rate limiting implemented consistent with existing patterns
7. [ ] Error responses follow established format

## Tasks / Subtasks

- [ ] **Task 1: Create Health Metrics API Endpoint** (AC: 1, 4, 7)
  - [ ] Create `src/app/api/health/[businessId]/route.ts` following existing patterns
  - [ ] Implement GET method to retrieve health metrics from HealthMetric model
  - [ ] Add proper authentication using existing NextAuth patterns
  - [ ] Include error handling with standardized error responses
  - [ ] Add input validation using Zod schema
  - [ ] Write unit tests for endpoint functionality

- [ ] **Task 2: Create Forecasts API Endpoint** (AC: 2, 4, 7)
  - [ ] Create `src/app/api/forecasts/[businessId]/route.ts` following existing patterns
  - [ ] Implement GET method to retrieve forecast data from ForecastResult model
  - [ ] Include confidence intervals in response structure
  - [ ] Add proper authentication and authorization checks
  - [ ] Implement error handling consistent with existing patterns
  - [ ] Write unit tests for forecast data retrieval

- [ ] **Task 3: Create Health Calculation Trigger Endpoint** (AC: 3, 4, 7)
  - [ ] Create `src/app/api/health/calculate/route.ts` for health score recalculation
  - [ ] Implement POST method to trigger health score recalculation
  - [ ] Add business ID validation and ownership verification
  - [ ] Include proper error handling and response status codes
  - [ ] Add rate limiting to prevent abuse
  - [ ] Write unit tests for calculation trigger functionality

- [ ] **Task 4: Define TypeScript Interfaces** (AC: 5)
  - [ ] Create `src/types/health.ts` for health-related type definitions
  - [ ] Define HealthMetricResponse interface with all health scores
  - [ ] Define ForecastResponse interface with confidence intervals
  - [ ] Define CalculationRequest and CalculationResponse interfaces
  - [ ] Export interfaces from `src/types/index.ts`

- [ ] **Task 5: Implement Rate Limiting** (AC: 6)
  - [ ] Apply existing rate limiting patterns to health calculation endpoint
  - [ ] Configure appropriate limits for each endpoint type
  - [ ] Add rate limit headers to responses
  - [ ] Test rate limiting functionality

- [ ] **Task 6: Integration Testing and Validation** (AC: 1, 2, 3, 7)
  - [ ] Write integration tests for all three endpoints
  - [ ] Test error scenarios and edge cases
  - [ ] Validate response formats match TypeScript interfaces
  - [ ] Test authentication and authorization flows
  - [ ] Verify rate limiting behavior

## Dev Notes

### **Previous Story Insights**

[Source: docs/stories/1.1.database-schema-extensions.md#completion-notes-list]

Story 1.1 successfully completed database foundation:

- HealthMetric model available with fields: overallScore, growthScore, operationalScore, financialScore, saleReadinessScore, confidenceLevel, trajectory
- ForecastResult model available with fields: forecastType, predictedValue, confidenceIntervalLower, confidenceIntervalUpper, confidenceScore
- All models use `cuid()` primary keys and include audit fields (createdAt, updatedAt)
- Proper foreign key relationships to Business model established
- Database migration scripts tested and verified working

### **API Architecture Context**

[Source: docs/brownfield-architecture.md#api-specifications]

**Existing API Patterns**:

- RESTful design with proper HTTP methods
- TypeScript interfaces for request/response
- Error handling and validation using Zod schemas
- Rate limiting implemented on AI endpoints
- NextAuth.js authentication integration

**Existing API Routes Structure**:

- `/api/auth/` - NextAuth.js authentication
- `/api/businesses/` - Business CRUD operations
- `/api/business-analysis/` - Valuation and analysis
- `/api/communications/` - Messaging and meetings
- `/api/upload/` - File upload handling

### **Authentication Patterns**

[Source: docs/brownfield-architecture.md#authentication--authorization]

- NextAuth.js integration with `getServerSession(authOptions)`
- Session-based authentication with user role verification
- Existing auth utilities in `src/lib/auth-utils.ts`
- User ownership verification for business-related endpoints

### **Data Models and Relationships**

[Source: prisma/schema.prisma from Story 1.1 completion]

**HealthMetric Model Fields**:

- `id` (String, cuid)
- `businessId` (String, foreign key to Business)
- `overallScore`, `growthScore`, `operationalScore`, `financialScore`, `saleReadinessScore` (SmallInt)
- `confidenceLevel` (SmallInt)
- `trajectory` (HealthTrajectory enum: IMPROVING, STABLE, DECLINING, VOLATILE)
- `calculatedAt`, `createdAt`, `updatedAt` (DateTime)
- `dataSources`, `calculationMetadata` (Json, optional)

**ForecastResult Model Fields**:

- `id` (String, cuid)
- `businessId` (String, foreign key to Business)
- `forecastType` (ForecastType enum: REVENUE, EXPENSES, PROFIT, CASH_FLOW, GROWTH_RATE)
- `forecastPeriod` (SmallInt)
- `predictedValue`, `confidenceIntervalLower`, `confidenceIntervalUpper` (Decimal 15,2)
- `confidenceScore` (SmallInt)
- `modelUsed` (String)
- `actualValue` (Decimal 15,2, optional)

### **File Locations and Conventions**

[Source: docs/brownfield-architecture.md#source-tree-and-module-organization]

**API Routes**: `src/app/api/` following Next.js 14 App Router patterns
**TypeScript Types**: `src/types/` with category-based organization
**Utilities**: `src/lib/` for shared functionality
**Authentication**: Existing patterns in `src/lib/auth-utils.ts`

### **Error Handling Patterns**

[Source: existing API routes analysis]

- Zod validation schemas for request validation
- Standardized error response format with proper HTTP status codes
- Authentication errors return 401 Unauthorized
- Authorization errors return 403 Forbidden
- Validation errors return 400 Bad Request with details
- Server errors return 500 Internal Server Error

### **Rate Limiting Implementation**

[Source: docs/brownfield-architecture.md#ai-integration]

- Rate limiting configured (10 requests/minute on AI endpoints)
- Retry logic with exponential backoff patterns available
- Cost tracking implemented for resource monitoring
- Pattern available in `src/lib/openai.ts` for reference

### **Testing Requirements**

[Source: docs/brownfield-architecture.md#technical-debt-and-known-issues]

- No test framework currently configured (noted as technical debt)
- Manual testing recommended through API endpoints
- TypeScript compilation serves as basic validation
- Integration testing through development server verification

### **Project Structure Notes**

All file paths align with established Next.js 14 App Router structure:

- API routes follow `/src/app/api/[...path]/route.ts` convention
- TypeScript types organized in `/src/types/` by domain
- No structural conflicts identified with existing patterns

## Change Log

| Date       | Version | Description            | Author      |
| ---------- | ------- | ---------------------- | ----------- |
| 2025-09-03 | 1.0     | Initial story creation | BMad Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be added here after implementation_
